name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  node:
    name: Node.js | Lint & Test
    if: ${{ hashFiles('package.json') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            npm-shrinkwrap.json
            pnpm-lock.yaml
            yarn.lock

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          elif [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm install --frozen-lockfile
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn install --frozen-lockfile
          else
            npm install
          fi

      - name: Lint
        run: |
          if npm run | grep -qE '^  lint'; then
            npm run lint
          else
            echo "Kein npm lint-Skript definiert (package.json:scripts.lint)."
            exit 1
          fi

      - name: Test
        run: |
          if npm run | grep -qE '^  test'; then
            npm test
          else
            echo "Kein npm test-Skript definiert (package.json:scripts.test)."
            # Falls Tests optional sein sollen: exit 0
            exit 1
          fi

  python:
    name: Python | Lint & Test
    if: ${{ hashFiles('pyproject.toml') != '' || hashFiles('requirements.txt') != '' || hashFiles('requirements-dev.txt') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            pyproject.toml
            poetry.lock

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          # Basis-Tools für Linting/Tests (falls nicht bereits im Projekt):
          python -m pip install ruff pytest

      - name: Lint (ruff)
        run: ruff check .

      - name: Test (pytest, wenn Tests vorhanden)
        run: |
          if ls -1 **/test_*.py **/*_test.py 2>/dev/null | grep -q . || [ -d tests ]; then
            pytest -q
          else
            echo "Keine Python-Tests gefunden."
            # Falls Tests optional sein sollen: exit 0
            exit 1
          fi

  java_maven:
    name: Java (Maven) | Lint & Test
    if: ${{ hashFiles('pom.xml') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Build + Test (Maven)
        run: mvn -B -DskipTests=false verify

      # Optional: Checkstyle/Spotless, falls im Projekt konfiguriert (wird im verify-Lifecycle ohnehin ausgeführt, wenn vorhanden)

  java_gradle:
    name: Java (Gradle) | Lint & Test
    if: ${{ hashFiles('**/build.gradle') != '' || hashFiles('**/build.gradle.kts') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: gradle/gradle-build-action@v3

      - name: Build + Test (Gradle)
        run: |
          chmod +x ./gradlew || true
          ./gradlew --version
          ./gradlew clean build --no-daemon

  dotnet:
    name: .NET | Lint & Test
    if: ${{ hashFiles('**/*.sln') != '' || hashFiles('**/*.csproj') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Test
        run: dotnet test --configuration Release --no-build --logger "trx;LogFileName=test-results.trx"

      - name: Lint (dotnet format, falls konfiguriert)
        run: |
          if command -v dotnet-format >/dev/null 2>&1; then
            dotnet format --verify-no-changes
          else
            echo "dotnet-format nicht installiert – überspringe Lint."
          fi
